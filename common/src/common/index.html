<!DOCTYPE html>
<head>
    <meta charset='utf-8'/>
    <title>common</title>
    <meta name='viewport' content='width=device-width'/>
    <meta content='yes' name='apple-mobile-web-app-capable'/>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script language='JavaScript' type='text/javascript' src='common.js'></script>
</head>

<body onload="setButtons()">
    <div style="width: 100%; overflow: hidden;">

        <div style="width: 500px; float: left;">
            <h1 style="padding-left:50px;">common 1.0.0</h1>
			
				<div style="padding-left:50px;border-spacing:100px;">
					
				<table>
					<tr>
						<td>Download</td>
						<td><input type='radio' name='downloadParameters' value='{"streams":4, "frameSize":2048, "lowerBound":0.01, "upperBound":1.05}'					>low</td>
						<td><input type='radio' name='downloadParameters' value='{"streams":4, "frameSize":32768, "lowerBound":0.95, "upperBound":525}' checked	>default</td>
						<td><input type='radio' name='downloadParameters' value='{"streams":4, "frameSize":524288, "lowerBound":475, "upperBound":1050}'		>high</td> 
						<td><input type='radio' name='downloadParameters' value='{"streams":8, "frameSize":524288, "lowerBound":950, "upperBound":9000}'		>very high</td> 
					</tr>

					<tr>
						<td>Upload</td>
						<td><input type='radio' name='uploadParameters'	value='{"streams":4, "frameSize":2048, "lowerBound":0.01, "upperBound":1.05}'				>low</td>
						<td><input type='radio' name='uploadParameters'	value='{"streams":4, "frameSize":65535, "lowerBound":0.95, "upperBound":525}' checked	>default</td>
						<td><input type='radio' name='uploadParameters'	value='{"streams":10, "frameSize":65535, "lowerBound":475, "upperBound":1050}'		>high</td>
						<td><input type='radio' name='uploadParameters'	value='{"streams":80, "frameSize":65535, "lowerBound":950, "upperBound":9000}'		>very high</td> 
					</tr>
					
					<tr>
						<td>IP Version</td>
						<td><input type='radio' name='ipVersion' checked	>auto</td>
						<td><input type='radio' name='ipVersion' 			>ipv4</td>
						<td><input type='radio' name='ipVersion' 			>ipv6</td>
						<td></td> 
					</tr>
					
					<tr>
						<td>Single Stream</td>
						<td><input type='radio' name='singleStream' checked	>off</td>
						<td><input type='radio' name='singleStream' 	>on</td>
						<td></td>
						<td></td> 
					</tr>
				</table>
            
                <br>
                <button id='loadButton' onclick='load()' disabled='disabled'		>Load</button>
                <button id='stopButton' onclick='speedStop()' disabled='disabled'	>Stop</button>
                <br>
                <br>

                <button id='speedStartButton' onclick='speedStart("all")'		>Start</button>
                <button id='rttButton' onclick='speedStart("rtt")'				>RTT</button>
                <button id='downloadButton' onclick='speedStart("download")'	>Download</button>
                <button id='uploadButton' onclick='speedStart("upload")'		>Upload</button>
			</div>
			<br><br>
			<h1 style="padding-left:50px;">port blocking 1.0.0</h1>
			
				<div style="padding-left:50px;border-spacing:100px;">
					
                <button id='portBlockingStartButton' onclick='portBlockingStart()'>Start</button>
            </div>
        </div>
        
        <div style="margin-left: 500px;">
            <br>
            <table>
                <tr>
                    <td><div style="padding-left:40px;border-spacing:20px;">Status: </div></td>
                    <td><div style="padding-left:20px;border-spacing:20px;" id="status">common loading</div></td>
                </tr>

                <tr>
                    <td><div style="padding-left:40px;border-spacing:20px;">RTT: </div></td>
                    <td><div style="padding-left:20px;border-spacing:20px;" id="rtt">-</div></td>
                </tr>

                <tr>
                    <td><div style="padding-left:40px;border-spacing:20px;">Download: </div></td>
                    <td><div style="padding-left:20px;border-spacing:20px;" id="download">-</div></td>
                </tr>

                <tr>
                    <td><div style="padding-left:40px;border-spacing:20px;">Upload: </div></td>
                    <td><div style="padding-left:20px;border-spacing:20px;" id="upload">-</div></td>
                </tr>
				
				<tr>
                    <td><div style="padding-left:40px;border-spacing:20px;">Port Blocking: </div></td>
                    <td><div style="padding-left:20px;border-spacing:20px;" id="port_blocking">-</div></td>
                </tr>
            </table>
                
            <div style="padding-left:50px;border-spacing:20px;"><pre id="kpis"></pre></div>
        </div>
        
    </div>

    <script type="text/javascript">
        
		/*
		 *********************************************************************************
		 *                                                                               *
		 *       ..--== zafaco GmbH ==--..                                               *
		 *                                                                               *
		 *       Website: http://www.zafaco.de                                           *
		 *                                                                               *
		 *       Copyright 2018 - 2019                                                   *
		 *                                                                               *
		 *********************************************************************************
		 */

		/*!
		 *      \author zafaco GmbH <info@zafaco.de>
		 *      \date Last update: 2019-02-05
		 *      \note Copyright (c) 2018 - 2019 zafaco GmbH. All rights reserved.
		 */
       
        var speed;
        var speedParameters = {};
		
		var portBlocking;
		var portBlockingParameters = {};

        function speedStart(testCase)
        {
            outputPrepare();
            
			speedParameters.cmd                               = 'start';
			speedParameters.platform                          = 'web';

			speedParameters.wsTargets                         = [];
			speedParameters.wsTargets.push('peer-ias-de-01');

			speedParameters.wsTargetsRtt                      = [];
			speedParameters.wsTargetsRtt.push('peer-ias-de-01');
			
			var ipVersion = document.getElementsByName('ipVersion');
			if (ipVersion[1].checked || ipVersion[2].checked)
			{
				var targetIpVersion;
				if (ipVersion[1].checked)
				{
					targetIpVersion = '-ipv4';
				}
				else if (ipVersion[2].checked)
				{
					targetIpVersion = '-ipv6';
				}
				
				speedParameters.wsTargets.forEach(function(element, index)
				{
					speedParameters.wsTargets[index] = speedParameters.wsTargets[index] + targetIpVersion;
				});
				
				speedParameters.wsTargetsRtt.forEach(function(element, index)
				{
					speedParameters.wsTargetsRtt[index] = speedParameters.wsTargetsRtt[index] + targetIpVersion;
				});
			}

			speedParameters.wsTLD                             = 'net-neutrality.tools';
			speedParameters.wsTargetPort                      = '80';
			speedParameters.wsWss                             = 0;
	
			speedParameters.wsAuthToken						  = 'placeholderToken';
			speedParameters.wsAuthTimestamp					  = 'placeholderTimestamp';

			speedParameters.wsWorkerPath                      = 'Worker.js';
			speedParameters.performRouteToClientLookup        = false;
			
            if (testCase === 'all')
            {
                speedParameters.performRttMeasurement         = true;
                speedParameters.performDownloadMeasurement    = true;
                speedParameters.performUploadMeasurement      = true;
            }
            if (testCase === 'rtt')
            {
                speedParameters.performRttMeasurement         = true;
                speedParameters.performDownloadMeasurement    = false;
                speedParameters.performUploadMeasurement      = false;
            }
            if (testCase === 'download')
            {
                speedParameters.performRttMeasurement         = false;
                speedParameters.performDownloadMeasurement    = true;
                speedParameters.performUploadMeasurement      = false;
            }
            if (testCase === 'upload')
            {
                speedParameters.performRttMeasurement         = false;
                speedParameters.performDownloadMeasurement    = false;
                speedParameters.performUploadMeasurement      = true;
            }
			
			
			var downloadParameters = document.getElementsByName('downloadParameters');
			for (var i=0; i<downloadParameters.length; i++) 
            {
				if (downloadParameters[i].checked)
				{
					var parsedDownloadParameters 						= JSON.parse(downloadParameters[i].value);
					speedParameters.wsParallelStreamsDownload			= parsedDownloadParameters.streams;
					speedParameters.wsFrameSizeDownload					= parsedDownloadParameters.frameSize;
					speedParameters.downloadThroughputLowerBoundMbps	= parsedDownloadParameters.lowerBound;
					speedParameters.downloadThroughputUpperBoundMbps	= parsedDownloadParameters.upperBound;
				}
			}
			
			var uploadParameters = document.getElementsByName('uploadParameters');
			for (var i=0; i<uploadParameters.length; i++) 
            {
				if (uploadParameters[i].checked)
				{
					var parsedUploadParameters 							= JSON.parse(uploadParameters[i].value);
					speedParameters.wsParallelStreamsUpload				= parsedUploadParameters.streams;
					speedParameters.wsFrameSizeUpload					= parsedUploadParameters.frameSize;
					speedParameters.uploadThroughputLowerBoundMbps		= parsedUploadParameters.lowerBound;
					speedParameters.uploadThroughputUpperBoundMbps		= parsedUploadParameters.upperBound;
				}
			}
			
			var singleStream = document.getElementsByName('singleStream');
			if (singleStream[1].checked)
			{
				speedParameters.wsFrameSizeDownload			*= speedParameters.wsParallelStreamsDownload;
				speedParameters.wsParallelStreamsDownload	= 1;
				
				speedParameters.wsFrameSizeUpload			*= speedParameters.wsFrameSizeUpload;
				speedParameters.wsParallelStreamsUpload 	= 1;
				
				if (speedParameters.wsFrameSizeUpload > 65535)
				{
					speedParameters.wsFrameSizeUpload = 65535;
				}
			}
			
            delete speed;
            speed = null;
            speed = new Speed();
            
            speed.measurementStart(speedParameters);
        }
        
        function speedStop()
        {
            wsMeasurement.measurementControl(JSON.stringify({cmd:'stop'}));
            
            toggleButtons(true);
        }
		
		function portBlockingStart()
		{
			outputPrepare();
            
			portBlockingParameters.platform		= 'web';
			portBlockingParameters.target		= 'peer-ias-de-01.net-neutrality.tools';
			portBlockingParameters.targetIpv4	= '82.199.148.52';
			portBlockingParameters.targetIpv6	= '2a01:4a0:f::11';
			
			portBlockingParameters.user			= 'berec';
			portBlockingParameters.password 	= 'berec';
			portBlockingParameters.ports		= [123, 500, 4500, 5060, 7000];
			portBlockingParameters.timeout		= 5000;
			
			delete portBlocking;
            portBlocking = null;
            portBlocking = new PortBlocking();
            
           	portBlocking.measurementStart(portBlockingParameters);
		}
        
        function setButtons()
        {
            toggleButtons(true);
			document.getElementById('loadButton').disabled                = true;
            
            document.getElementById('status').innerHTML                   = 'MeasurementLoad successful';
        }
        
        function toggleButtons(enable)
        {
            document.getElementById('speedStartButton').disabled          = !enable; 
            document.getElementById('rttButton').disabled                 = !enable;       
            document.getElementById('downloadButton').disabled            = !enable;
            document.getElementById('uploadButton').disabled              = !enable;
            document.getElementById('stopButton').disabled                = enable;
			document.getElementById('loadButton').disabled                = !enable;
			document.getElementById('portBlockingStartButton').disabled   = !enable;
        }

        function measurementCallback(data)
        {
            outputData(data);
        }
        
        function outputPrepare()
        {
            outputClear();
            toggleButtons(false);
        }

        function outputClear()
        {
            document.getElementById('status').innerHTML = 'MeasurementLoad successful';
            document.getElementById('rtt').innerHTML = '-';
            document.getElementById('download').innerHTML = '-';
            document.getElementById('upload').innerHTML = '-';
			document.getElementById('port_blocking').innerHTML = '-';
            document.getElementById('kpis').innerHTML = '';
        }

        function outputData(data)
        {
            data = JSON.parse(data);

            switch (data.cmd)
            {
                case 'info':
				{
					outputToHtml('Measurement running', 'status');
					break;
				}
                
                case 'completed':
                {
					outputToHtml('Measurement successful', 'status');
					outputToHtml(JSON.stringify(orderKeys(data), null, 4), 'kpis');
					document.getElementById('stopButton').disabled = true;
					break;
                }
                
                case 'finish':
                {
                    outputToHtml(data.test_case + ': ' + data.msg, 'status');
					document.getElementById('loadButton').disabled = false;
                }
                
                case 'report':
                {
					outputToHtml('Measurement running', 'status');
					var output = '';

					if (data.test_case === 'rtt' && data.rtt_info.average_ns !== 0)
					{
						outputToHtml(data.rtt_info.average_ns, 'rtt');
					}
					if (data.test_case === 'download' && data.download_info.throughput_avg_bps !== 0)
					{
						outputToHtml((data.download_info.throughput_avg_bps / 1000 / 1000).toFixed(2), 'download');
					}
					if (data.test_case === 'upload' && data.upload_info.throughput_avg_bps !== 0)
					{
						outputToHtml((data.upload_info.throughput_avg_bps / 1000 / 1000).toFixed(2), 'upload');
					}
					if (data.test_case === 'port_blocking' && data.port_blocking.results.length !== 0)
					{
						var reachable = 0;
						data.port_blocking.results.forEach(function(element)
						{
							if (element.reachable === true) reachable++;
						});
						
						outputToHtml('' + reachable + ' of ' + data.port_blocking.results.length + ' reachable', 'port_blocking');
					}

					outputToHtml(JSON.stringify(orderKeys(data), null, 4), 'kpis');
                    break;
                }
                
                case 'error':
                {
                    outputToHtml(data.test_case + ': ' + data.msg, 'status');
                    outputToHtml(JSON.stringify(orderKeys(data), null, 4), 'kpis');
                    document.getElementById('stopButton').disabled = true;
					document.getElementById('loadButton').disabled = false;
                    break;
                }
            }
        }

        function outputToHtml(output, id)
        {
            var element = document.getElementById(id);

            if (id === 'rtt')       output = output + ' ns';
            if (id === 'download')  output = output + ' Mbit/s';
            if (id === 'upload')    output = output + ' Mbit/s';

            element.innerHTML = output;
        }

        function load()
        {
             location.reload();
        }
        
        function orderKeys(obj)
        {
            var keys = Object.keys(obj).sort(function keyOrder(k1, k2)
            {
                if (k1 < k2) return -1;
                else if (k1 > k2) return +1;
                else return 0;
            });

            var i, after = {};
            for (i = 0; i < keys.length; i++)
            {
                after[keys[i]] = obj[keys[i]];
                delete obj[keys[i]];
            }

            for (i = 0; i < keys.length; i++)
            {
                obj[keys[i]] = after[keys[i]];
            }
            
            return obj;
        }

    </script>

</body>
</html>